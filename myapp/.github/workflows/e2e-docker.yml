name: e2e (docker + playwright)

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
      # 1) 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2) 构建 Docker 镜像（把你的项目 + 依赖装进去）
      - name: Build e2e image
        run: docker build -f Dockerfile.e2e -t myapp-e2e:ci .

      # 3) 创建报告输出目录（让 docker volume 挂载不出错）
      - name: Prepare report dirs
        run: |
          mkdir -p playwright-report
          mkdir -p test-results

      # 4) 运行容器并执行 Playwright 测试
      #    - 把报告目录挂载出来，跑完后 workflow 可以上传
      - name: Run e2e tests in container
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/playwright-report:/app/playwright-report \
            -v ${{ github.workspace }}/test-results:/app/test-results \
            myapp-e2e:ci

      # 5) 上传 Playwright HTML 报告（无论成功失败都上传，便于排错）
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 7

      # 6) 上传 test-results（里面通常有 trace/video/screenshot）
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results
          retention-days: 7
